#!/usr/bin/python3

import sys
import os
import git
import datetime
from pyvis.network import Network

def shorthash(commit) :
    return str(commit)[0:5]

def shortmsg(commit) :
    return str(commit.message).split('\n',1)[0]

repodir = os.getcwd()
if len(sys.argv) == 2 :
    repodir = sys.argv[1]

print("git-3d has started for" + repodir)

# load git repository
repo = git.Repo(repodir)
assert not repo.bare

# init network graph object
net = Network(height=800, width=800)

# load all commits
commit_list = list(repo.iter_commits())
commit_list.sort(key=lambda c: c.committed_datetime.timestamp())
pos = 0

print("Commit list:")
for c in commit_list :
    print(shorthash(c) + ": " + shortmsg(c))
    ts = int(c.committed_datetime.timestamp())
    net.add_node(str(c),    \
        label=shortmsg(c),  \
        title=c.message,    \
        value=10,           \
        y=pos)
    pos = pos + 100

# add edges between commits
print("Adding edges:")
for c in commit_list :
    for p in c.parents :
        print(shorthash(c) + " -> " + shorthash(p))
        net.add_edge(str(c), str(p))

print("Showing Graph:")
net.show("/tmp/git3d-" + repodir.split('/')[-1] + ".html")
